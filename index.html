<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workout Tracker ¬∑ Full History & Drag</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  background: #111;
  color: white;
}
.container { padding: 20px; max-width: 600px; margin: 0 auto; }
button {
  padding: 10px;
  margin: 5px 0;
  background: #2a2a2a;
  color: white;
  border: none;
  border-radius: 8px;
  width: 100%;
  font-weight: 500;
  cursor: pointer;
}
button:hover { background: #3a3a3a; }
button.small-btn {
  width: auto;
  padding: 5px 10px;
  font-size: 12px;
  margin: 2px;
}
input, select, textarea {
  padding: 8px;
  margin: 4px 0;
  border-radius: 6px;
  border: none;
  width: 100%;
  background: #222;
  color: white;
}
.exercise-card {
  background: #1c1c1c;
  padding: 12px;
  margin: 8px 0;
  border-radius: 10px;
  border-left: 3px solid #4caf50;
  cursor: grab;
  transition: background 0.2s;
}
.exercise-card.dragging {
  opacity: 0.5;
  background: #333;
  cursor: grabbing;
}
.exercise-card .drag-handle {
  font-size: 20px;
  margin-right: 8px;
  color: #888;
  user-select: none;
}
.timer {
  font-size: 32px;
  text-align: center;
  margin: 15px 0;
  background: #000;
  padding: 10px;
  border-radius: 20px;
  font-weight: 600;
}
.flex-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}
.history-item, .template-item {
  background: #1c1c1c;
  padding: 12px;
  margin: 10px 0;
  border-radius: 10px;
}
.history-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}
.version-badge {
  background: #333;
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 12px;
  color: #aaa;
  text-align: center;
}
.edit-exercise-form {
  background: #2a2a2a;
  padding: 12px;
  border-radius: 8px;
  margin: 8px 0;
}
</style>
</head>
<body>
<div class="container" id="app"></div>

<script>
(function() {
const APP_VERSION = '2.3.0'; // updated version

// ----- DEFAULT TEMPLATES -----
let defaultTemplates = [
  {
    id: 'upper1-' + Date.now() + '-1',
    name: "Upper 1 ‚Äì Pull Dominant",
    rest: 120,
    repRange: "8-15",
    exercises: [
      { name: "Vertical Pull (Wide Grip)", sets: 2 },
      { name: "Horizontal Row", sets: 2 },
      { name: "Vertical Pull (Close / Neutral)", sets: 2 },
      { name: "Incline Press (60¬∞)", sets: 2 },
      { name: "Lateral Raises", sets: 2 },
      { name: "Optional Arms", sets: 2 }
    ]
  },
  {
    id: 'lower1-' + Date.now() + '-2',
    name: "Lower 1 ‚Äì Quad Emphasis",
    rest: 120,
    repRange: "8-15",
    exercises: [
      { name: "Quad Dominant Squat", sets: 3 },
      { name: "Bulgarian Split Squats (Shorter Stride)", sets: 3 },
      { name: "Romanian Deadlift", sets: 3 },
      { name: "Hip Thrust", sets: 3 }
    ]
  },
  {
    id: 'upper2-' + Date.now() + '-3',
    name: "Upper 2 ‚Äì Push Dominant",
    rest: 120,
    repRange: "8-15",
    exercises: [
      { name: "Overhead Press", sets: 2 },
      { name: "Incline Press (60¬∞)", sets: 2 },
      { name: "Lateral Raises", sets: 2 },
      { name: "Horizontal Row (Different Variation)", sets: 2 },
      { name: "Vertical Pull (Neutral or Supinated)", sets: 2 },
      { name: "Optional Arms", sets: 2 }
    ]
  },
  {
    id: 'lower2-' + Date.now() + '-4',
    name: "Lower 2 ‚Äì Glute / Hinge Emphasis",
    rest: 120,
    repRange: "8-15",
    exercises: [
      { name: "Romanian Deadlift (Primary Hinge)", sets: 3 },
      { name: "Hip Thrust (Heavier Than Lower 1)", sets: 3 },
      { name: "Glute Dominant Squat", sets: 3 },
      { name: "Bulgarian Split Squats (Longer Stride)", sets: 3 }
    ]
  },
  {
    id: 'full-' + Date.now() + '-5',
    name: "Full",
    rest: 120,
    repRange: "8-15",
    exercises: [
      { name: "Pull up/down", sets: 2 },
      { name: "Incline push", sets: 2 },
      { name: "Horizontal pull", sets: 2 },
      { name: "Lateral raises", sets: 2 },      
      { name: "Romanian Deadlift (Primary Hinge)", sets: 3 },
      { name: "Goblet squats", sets: 3 },
      { name: "Bulgarian Split Squats", sets: 3 }
    ]
  }
];

// ----- LOAD & MERGE EXISTING DATA -----
let savedData = JSON.parse(localStorage.getItem("workoutApp")) || { templates: [], activeWorkout: null, history: [] };

// Merge default templates without overwriting user edits (by name)
defaultTemplates.forEach(defTpl => {
  const exists = savedData.templates.some(t => t.name === defTpl.name);
  if (!exists) savedData.templates.push(defTpl);
});

// Ensure IDs
savedData.templates = savedData.templates.map(t => ({
  id: t.id || 'tpl-' + Date.now() + '-' + Math.random().toString(36),
  ...t
}));

let data = savedData;
localStorage.setItem("workoutApp_version", APP_VERSION);

function save() { localStorage.setItem("workoutApp", JSON.stringify(data)); }

// ----- SHARE / IMPORT -----
function parseShareLink() {
  const hash = window.location.hash.substring(1);
  if (!hash) return;
  try {
    const decoded = atob(hash);
    const imported = JSON.parse(decoded);
    if (imported && Array.isArray(imported)) {
      imported.forEach(t => {
        t.id = 'shared-' + Date.now() + '-' + Math.random().toString(36).substring(2,8);
      });
      data.templates = [...data.templates, ...imported];
      save();
      alert('Imported ' + imported.length + ' template(s) from link!');
      window.location.hash = '';
    }
  } catch (e) {}
}
parseShareLink();

// ----- TIMER GLOBAL -----
let timerInterval = null;

// ----- RENDER HOME -----
function renderHome() {
  const app = document.getElementById("app");
  app.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>üìã Templates</h2>
      <span class="version-badge">v${APP_VERSION}</span>
    </div>
    <button onclick="createTemplate()">‚ûï Create Template</button>
    <button onclick="exportPrompt()" style="background:#1e3a5f;">üîó Share / Import</button>
    <div id="templateList">
      ${data.templates.map((t,i)=>`
        <div class="template-item">
          <div style="display:flex; justify-content:space-between;">
            <b>${t.name}</b> <span style="color:#888;">${t.exercises.length} ex</span>
          </div>
          <div class="flex-row" style="margin-top:8px;">
            <button class="small-btn" onclick="startWorkout('${t.id}')">‚ñ∂Ô∏è Start</button>
            <button class="small-btn" onclick="editTemplate('${t.id}')">‚úèÔ∏è Edit</button>
            <button class="small-btn" onclick="deleteTemplate('${t.id}')">üóëÔ∏è</button>
            <button class="small-btn" onclick="selectForShare('${t.id}')" style="background:#3a2a2a;">üîó Select</button>
          </div>
        </div>
      `).join("")}
    </div>

    <h3 style="margin-top:24px;">üìú Full History (${data.history.length})</h3>
    <button class="small-btn" onclick="clearAllHistory()" style="background:#5f1f1f;">üóëÔ∏è Clear All History</button>
    <div id="historyList">
      ${data.history.slice().reverse().map((s, idx) => {
        const realIndex = data.history.length - 1 - idx;
        return `
        <div class="history-item">
          <div style="display:flex; justify-content:space-between;">
            <b>${s.templateName}</b>
            <span style="color:#aaa;">${new Date(s.date).toLocaleString()}</span>
          </div>
          <details>
            <summary>View details</summary>
            ${s.logs.map(l => `
              <div style="margin:6px 0; background:#2a2a2a; padding:6px; border-radius:6px;">
                <b>${l.name}</b><br>
                ${l.sets.map((set, setIdx) => `Set ${setIdx+1}: ${set.weight || '?'} kg √ó ${set.reps || '?'} reps`).join('<br>')}
              </div>
            `).join('')}
          </details>
          <div class="history-actions">
            <button class="small-btn" onclick="deleteHistoryEntry(${realIndex})" style="background:#7a2a2a;">Delete</button>
          </div>
        </div>
      `}).join('')}
      ${data.history.length === 0 ? '<p style="color:#666;">No past workouts yet.</p>' : ''}
    </div>
  `;
}

// ----- REST TIMER -----
function startTimer(seconds){
  const timerDiv = document.getElementById("timer");
  if (!timerDiv) return;

  const endTime = Date.now() + seconds * 1000;
  clearInterval(timerInterval);

  function update() {
    const remaining = Math.max(0, Math.round((endTime - Date.now()) / 1000));
    if (timerDiv) timerDiv.innerText = formatTime(remaining);
    if (remaining <= 0) {
      clearInterval(timerInterval);
      alert("Rest over!");
    }
  }
  update();
  timerInterval = setInterval(update, 500);
}

function formatTime(s){
  const m = Math.floor(s/60);
  const sec = s%60;
  return `${m}:${sec<10?"0":""}${sec}`;
}

// ----- ACTIVE WORKOUT RESTORE -----
if (data.activeWorkout?.timerEnd) {
  const remaining = Math.max(0, Math.round((data.activeWorkout.timerEnd - Date.now()) / 1000));
  if (remaining > 0) startTimer(remaining);
}

// ----- GLOBAL FUNCTIONS -----
window.renderHome = renderHome;
window.save = save;

renderHome();
})();
</script>
</body>
</html>
