<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workout Tracker ¬∑ v2.3 (merge + bg timer)</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  background: #111;
  color: white;
}
.container { padding: 20px; max-width: 600px; margin: 0 auto; }
button {
  padding: 10px;
  margin: 5px 0;
  background: #2a2a2a;
  color: white;
  border: none;
  border-radius: 8px;
  width: 100%;
  font-weight: 500;
  cursor: pointer;
}
button:hover { background: #3a3a3a; }
button.small-btn {
  width: auto;
  padding: 5px 10px;
  font-size: 12px;
  margin: 2px;
}
input, select, textarea {
  padding: 8px;
  margin: 4px 0;
  border-radius: 6px;
  border: none;
  width: 100%;
  background: #222;
  color: white;
}
.exercise-card {
  background: #1c1c1c;
  padding: 12px;
  margin: 8px 0;
  border-radius: 10px;
  border-left: 3px solid #4caf50;
  cursor: grab;
  transition: background 0.2s;
}
.exercise-card.dragging {
  opacity: 0.5;
  background: #333;
  cursor: grabbing;
}
.exercise-card .drag-handle {
  font-size: 20px;
  margin-right: 8px;
  color: #888;
  user-select: none;
}
.timer {
  font-size: 32px;
  text-align: center;
  margin: 15px 0;
  background: #000;
  padding: 10px;
  border-radius: 20px;
  font-weight: 600;
}
.flex-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}
.history-item, .template-item {
  background: #1c1c1c;
  padding: 12px;
  margin: 10px 0;
  border-radius: 10px;
}
.history-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}
.version-badge {
  background: #333;
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 12px;
  color: #aaa;
  text-align: center;
}
.edit-exercise-form {
  background: #2a2a2a;
  padding: 12px;
  border-radius: 8px;
  margin: 8px 0;
}
.import-export-bar {
  display: flex;
  gap: 6px;
  margin: 10px 0;
  flex-wrap: wrap;
}
</style>
</head>
<body>
<div class="container" id="app"></div>

<script>
(function() {
  const APP_VERSION = '2.3.0'; // merge + background timer + history export

  // ----- DEFAULT TEMPLATES WITH STABLE IDs (never change) -----
  const DEFAULT_TEMPLATES = [
    {
      id: 'default_upper1',        // stable ID
      name: "Upper 1 ‚Äì Pull Dominant",
      rest: 120,
      repRange: "8-15",
      exercises: [
        { name: "Vertical Pull (Wide Grip)", sets: 2 },
        { name: "Horizontal Row", sets: 2 },
        { name: "Vertical Pull (Close / Neutral)", sets: 2 },
        { name: "Incline Press (60¬∞)", sets: 2 },
        { name: "Lateral Raises", sets: 2 },
        { name: "Optional Arms", sets: 2 }
      ]
    },
    {
      id: 'default_lower1',
      name: "Lower 1 ‚Äì Quad Emphasis",
      rest: 120,
      repRange: "8-15",
      exercises: [
        { name: "Quad Dominant Squat", sets: 3 },
        { name: "Bulgarian Split Squats (Shorter Stride)", sets: 3 },
        { name: "Romanian Deadlift", sets: 3 },
        { name: "Hip Thrust", sets: 3 }
      ]
    },
    {
      id: 'default_upper2',
      name: "Upper 2 ‚Äì Push Dominant",
      rest: 120,
      repRange: "8-15",
      exercises: [
        { name: "Overhead Press", sets: 2 },
        { name: "Incline Press (60¬∞)", sets: 2 },
        { name: "Lateral Raises", sets: 2 },
        { name: "Horizontal Row (Different Variation)", sets: 2 },
        { name: "Vertical Pull (Neutral or Supinated)", sets: 2 },
        { name: "Optional Arms", sets: 2 }
      ]
    },
    {
      id: 'default_lower2',
      name: "Lower 2 ‚Äì Glute / Hinge Emphasis",
      rest: 120,
      repRange: "8-15",
      exercises: [
        { name: "Romanian Deadlift (Primary Hinge)", sets: 3 },
        { name: "Hip Thrust (Heavier Than Lower 1)", sets: 3 },
        { name: "Glute Dominant Squat", sets: 3 },
        { name: "Bulgarian Split Squats (Longer Stride)", sets: 3 }
      ]
    },
    {
      id: 'default_full',
      name: "Full Body",
      rest: 120,
      repRange: "8-15",
      exercises: [
        { name: "Pull up/down", sets: 2 },
        { name: "Incline push", sets: 2 },
        { name: "Horizontal pull", sets: 2 },
        { name: "Lateral raises", sets: 2 },      
        { name: "Romanian Deadlift", sets: 3 },
        { name: "Goblet squats", sets: 3 },
        { name: "Bulgarian Split Squats", sets: 3 }
      ]
    }
  ];

  // ----- Load or initialise data with merging logic -----
  let stored = JSON.parse(localStorage.getItem("workoutApp")) || null;
  let data;

  if (!stored) {
    // Fresh install
    data = {
      templates: [...DEFAULT_TEMPLATES],
      activeWorkout: null,
      history: [],
      version: APP_VERSION
    };
  } else {
    // Version mismatch? merge defaults preserving user changes & history
    if (stored.version !== APP_VERSION) {
      // Start with stored templates (user modified)
      let mergedTemplates = stored.templates || [];

      // Add any default template that is not already present (by stable ID)
      DEFAULT_TEMPLATES.forEach(def => {
        const exists = mergedTemplates.some(t => t.id === def.id);
        if (!exists) {
          mergedTemplates.push(def); // new workout added by developer
        }
      });

      // Preserve everything else
      data = {
        templates: mergedTemplates,
        activeWorkout: stored.activeWorkout || null,
        history: stored.history || [],        // keep all history
        version: APP_VERSION
      };
    } else {
      data = stored;
    }
  }

  // Ensure every template has an id (legacy user-created might lack)
  data.templates = data.templates.map(t => ({
    id: t.id || 'user-' + Date.now() + '-' + Math.random().toString(36).substring(2,8),
    ...t
  }));

  function save() {
    localStorage.setItem("workoutApp", JSON.stringify(data));
  }

  // ----- Timer background handling -----
  let timerInterval = null;

  function clearTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function startTimer(seconds) {
    if (!data.activeWorkout) return;
    const endTime = Date.now() + seconds * 1000;
    data.activeWorkout.timerEnd = endTime;
    save();
    updateTimerDisplay(); // immediate update
    clearTimer();
    timerInterval = setInterval(() => {
      if (!data.activeWorkout) {
        clearTimer();
        return;
      }
      updateTimerDisplay();
    }, 200);
  }

  function updateTimerDisplay() {
    const timerDiv = document.getElementById('timer');
    if (!timerDiv) return;

    if (!data.activeWorkout || !data.activeWorkout.timerEnd) {
      timerDiv.innerText = '0:00';
      return;
    }

    const remaining = Math.max(0, Math.floor((data.activeWorkout.timerEnd - Date.now()) / 1000));
    timerDiv.innerText = formatTime(remaining);

    if (remaining <= 0) {
      clearTimer();
      if (data.activeWorkout) delete data.activeWorkout.timerEnd;
      save();
      timerDiv.innerText = '0:00';
      alert('Rest over!');
    }
  }

  function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return `${m}:${sec < 10 ? '0' : ''}${sec}`;
  }

  // Resume timer on page load / visibility change
  function resumeTimerIfNeeded() {
    if (data.activeWorkout && data.activeWorkout.timerEnd) {
      const remaining = Math.floor((data.activeWorkout.timerEnd - Date.now()) / 1000);
      if (remaining > 0) {
        clearTimer();
        timerInterval = setInterval(updateTimerDisplay, 200);
        updateTimerDisplay();
      } else {
        delete data.activeWorkout.timerEnd;
        save();
      }
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      resumeTimerIfNeeded();
      if (data.activeWorkout) renderWorkout(); // refresh view
    }
  });

  // ----- SHARE / IMPORT (templates) -----
  function parseShareLink() {
    const hash = window.location.hash.substring(1);
    if (!hash) return;
    try {
      const decoded = atob(hash);
      const imported = JSON.parse(decoded);
      if (imported && Array.isArray(imported)) {
        imported.forEach(t => {
          t.id = 'shared-' + Date.now() + '-' + Math.random().toString(36).substring(2,8);
        });
        data.templates = [...data.templates, ...imported];
        save();
        alert('Imported ' + imported.length + ' template(s) from link!');
        window.location.hash = '';
      }
    } catch (e) {}
  }
  parseShareLink();

  // ----- RENDER HOME with history export/import -----
  function renderHome() {
    const app = document.getElementById("app");
    app.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>üìã Templates</h2>
        <span class="version-badge">v${APP_VERSION}</span>
      </div>
      <button onclick="createTemplate()">‚ûï Create Template</button>
      <button onclick="exportPrompt()" style="background:#1e3a5f;">üîó Share / Import Templates</button>
      <div id="templateList">
        ${data.templates.map((t,i)=>`
          <div class="template-item">
            <div style="display:flex; justify-content:space-between;">
              <b>${t.name}</b> <span style="color:#888;">${t.exercises.length} ex</span>
            </div>
            <div class="flex-row" style="margin-top:8px;">
              <button class="small-btn" onclick="startWorkout('${t.id}')">‚ñ∂Ô∏è Start</button>
              <button class="small-btn" onclick="editTemplate('${t.id}')">‚úèÔ∏è Edit</button>
              <button class="small-btn" onclick="deleteTemplate('${t.id}')">üóëÔ∏è</button>
              <button class="small-btn" onclick="selectForShare('${t.id}')" style="background:#3a2a2a;">üîó Select</button>
            </div>
          </div>
        `).join("")}
      </div>

      <h3 style="margin-top:24px;">üìú Full History (${data.history.length})</h3>
      <div class="import-export-bar">
        <button class="small-btn" onclick="exportHistory()" style="background:#2a5f2a;">üì§ Export History</button>
        <button class="small-btn" onclick="importHistoryPrompt()" style="background:#5f2a5f;">üì• Import History</button>
        <button class="small-btn" onclick="clearAllHistory()" style="background:#5f1f1f;">üóëÔ∏è Clear All</button>
      </div>
      <div id="historyList">
        ${data.history.slice().reverse().map((s, idx) => {
          const realIndex = data.history.length - 1 - idx;
          return `
          <div class="history-item">
            <div style="display:flex; justify-content:space-between;">
              <b>${s.templateName}</b>
              <span style="color:#aaa;">${new Date(s.date).toLocaleString()}</span>
            </div>
            <details>
              <summary>View details</summary>
              ${s.logs.map(l => `
                <div style="margin:6px 0; background:#2a2a2a; padding:6px; border-radius:6px;">
                  <b>${l.name}</b><br>
                  ${l.sets.map((set, setIdx) => `
                    Set ${setIdx+1}: ${set.weight || '?'} kg √ó ${set.reps || '?'} reps
                  `).join('<br>')}
                </div>
              `).join('')}
            </details>
            <div class="history-actions">
              <button class="small-btn" onclick="deleteHistoryEntry(${realIndex})" style="background:#7a2a2a;">Delete</button>
            </div>
          </div>
        `}).join('')}
        ${data.history.length === 0 ? '<p style="color:#666;">No past workouts yet.</p>' : ''}
      </div>
    `;

    if (selectedShareIds.length > 0) {
      let bar = document.getElementById('shareBar');
      if (!bar) {
        bar = document.createElement('div');
        bar.id = 'shareBar';
        bar.style.position = 'sticky';
        bar.style.bottom = '10px';
        bar.style.background = '#2c3e50';
        bar.style.padding = '10px';
        bar.style.borderRadius = '30px';
        bar.style.marginTop = '10px';
        bar.style.display = 'flex';
        bar.style.gap = '8px';
        document.getElementById('app').appendChild(bar);
      }
      bar.innerHTML = `
        <span>${selectedShareIds.length} selected</span>
        <button class="small-btn" onclick="copyShareLink()">üìã Copy link</button>
        <button class="small-btn" onclick="selectedShareIds=[]; renderHome();">‚úñ Clear</button>
      `;
    }
  }

  // ----- HISTORY EXPORT / IMPORT -----
  window.exportHistory = () => {
    const historyData = data.history.map(entry => ({
      date: entry.date,
      templateName: entry.templateName,
      logs: entry.logs,
      id: entry.id
    }));
    const jsonStr = JSON.stringify(historyData, null, 2);
    const blob = new Blob([jsonStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `workout_history_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  window.importHistoryPrompt = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,application/json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!Array.isArray(imported)) throw new Error('Not an array');
          // optional: validate structure
          const safe = imported.filter(entry => entry.templateName && entry.logs && Array.isArray(entry.logs));
          if (safe.length === 0) return alert('No valid history entries found.');
          data.history = [...data.history, ...safe];
          save();
          renderHome();
          alert(`Imported ${safe.length} history entries.`);
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  window.deleteHistoryEntry = (index) => {
    if (confirm('Delete this history entry?')) {
      data.history.splice(index, 1);
      save();
      renderHome();
    }
  };

  window.clearAllHistory = () => {
    if (confirm('Delete ALL history? This cannot be undone.')) {
      data.history = [];
      save();
      renderHome();
    }
  };

  // ----- SHARE SELECTION (unchanged) -----
  let selectedShareIds = [];
  window.selectForShare = (id) => {
    if (selectedShareIds.includes(id)) {
      selectedShareIds = selectedShareIds.filter(sid => sid !== id);
    } else {
      selectedShareIds.push(id);
    }
    renderHome();
  };

  window.copyShareLink = () => {
    const selected = data.templates.filter(t => selectedShareIds.includes(t.id));
    if (!selected.length) return alert('No templates selected');
    const clean = selected.map(({ id, name, rest, repRange, exercises }) => ({
      id, name, rest, repRange, exercises
    }));
    const encoded = btoa(JSON.stringify(clean));
    const url = window.location.origin + window.location.pathname + '#' + encoded;
    navigator.clipboard.writeText(url).then(() => {
      alert('Share link copied!');
      selectedShareIds = [];
      renderHome();
    });
  };

  window.exportPrompt = () => {
    const importCode = prompt('Paste a share link or JSON to import templates:');
    if (!importCode) return;
    try {
      let parsed;
      if (importCode.startsWith('http')) {
        const hash = importCode.split('#')[1];
        if (!hash) throw new Error('No hash');
        parsed = JSON.parse(atob(hash));
      } else {
        parsed = JSON.parse(importCode);
      }
      if (Array.isArray(parsed)) {
        parsed.forEach(t => {
          t.id = 'imported-' + Date.now() + '-' + Math.random().toString(36);
          data.templates.push(t);
        });
        save();
        renderHome();
        alert('Imported successfully.');
      } else throw new Error('Invalid format');
    } catch (e) {
      alert('Could not import. Make sure it is a valid share link or JSON array.');
    }
  };

  // ----- TEMPLATE CRUD -----
  window.createTemplate = () => {
    const name = prompt("Template Name:");
    if(!name) return;
    data.templates.push({
      id: 'manual-' + Date.now() + '-' + Math.random().toString(36),
      name,
      rest: 120,
      repRange: "8-15",
      exercises: []
    });
    save();
    renderHome();
  };

  window.deleteTemplate = (id) => {
    if(confirm("Delete template?")){
      data.templates = data.templates.filter(t => t.id !== id);
      save();
      renderHome();
    }
  };

  function findTemplateIndex(id) {
    return data.templates.findIndex(t => t.id === id);
  }

  // ----- EDIT TEMPLATE (with drag) -----
  window.editTemplate = (id) => {
    const i = findTemplateIndex(id);
    if (i === -1) return renderHome();
    const template = data.templates[i];
    const app = document.getElementById("app");

    app.innerHTML = `
      <button onclick="renderHome()">‚Üê Back</button>
      <h2>${template.name}</h2>
      <label>Rest (seconds)</label>
      <input value="${template.rest}" onchange="updateRest('${id}',this.value)">
      <h3>Exercises (drag handle ‚ãÆ‚ãÆ to reorder)</h3>
      <div id="exerciseList" style="margin: 10px 0;">
        ${template.exercises.map((e, ei) => `
          <div class="exercise-card" draggable="true" data-index="${ei}" data-id="${id}">
            <div style="display:flex; align-items:center;">
              <span class="drag-handle">‚ãÆ‚ãÆ</span>
              <div style="flex:1;">
                <b>${e.name}</b> (${e.sets} sets)
              </div>
            </div>
            <div class="flex-row" style="margin-top:8px; justify-content:flex-end;">
              <button class="small-btn" onclick="editExercise('${id}', ${ei})">‚úèÔ∏è Edit</button>
              <button class="small-btn" onclick="deleteExercise('${id}', ${ei})">üóëÔ∏è</button>
            </div>
          </div>
        `).join("")}
      </div>
      <button onclick="addExercise('${id}')">+ Add Exercise</button>
    `;

    // drag & drop
    const list = document.getElementById('exerciseList');
    let draggedItem = null;

    list.querySelectorAll('.exercise-card').forEach(card => {
      card.addEventListener('dragstart', (e) => {
        draggedItem = card;
        card.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', card.dataset.index);
      });

      card.addEventListener('dragend', () => {
        card.classList.remove('dragging');
        draggedItem = null;
      });

      card.addEventListener('dragover', (e) => e.preventDefault());
      card.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!draggedItem || draggedItem === card) return;
        const fromIndex = parseInt(draggedItem.dataset.index);
        const toIndex = parseInt(card.dataset.index);
        const templateId = card.dataset.id;
        const tIdx = findTemplateIndex(templateId);
        if (tIdx === -1) return;
        const exercises = data.templates[tIdx].exercises;
        const [moved] = exercises.splice(fromIndex, 1);
        exercises.splice(toIndex, 0, moved);
        save();
        editTemplate(templateId);
      });
    });
  };

  window.editExercise = (templateId, exerciseIdx) => {
    const i = findTemplateIndex(templateId);
    if (i === -1) return;
    const exercise = data.templates[i].exercises[exerciseIdx];
    const newName = prompt("Edit exercise name:", exercise.name);
    if (newName === null) return;
    const newSets = prompt("Number of sets:", exercise.sets);
    if (newSets === null) return;
    exercise.name = newName;
    exercise.sets = parseInt(newSets) || exercise.sets;
    save();
    editTemplate(templateId);
  };

  window.updateRest = (id,val) => {
    const i = findTemplateIndex(id);
    if (i!==-1) data.templates[i].rest = parseInt(val);
    save();
  };

  window.addExercise = (id) => {
    const i = findTemplateIndex(id);
    if (i===-1) return;
    const name = prompt("Exercise name:");
    const sets = prompt("Number of sets:", 2);
    if(!name) return;
    data.templates[i].exercises.push({ name, sets: parseInt(sets) });
    save();
    editTemplate(id);
  };

  window.deleteExercise = (id, ei) => {
    const i = findTemplateIndex(id);
    data.templates[i].exercises.splice(ei,1);
    save();
    editTemplate(id);
  };

  // ----- WORKOUT -----
  window.startWorkout = (id) => {
    const i = findTemplateIndex(id);
    if (i===-1) return;
    const template = JSON.parse(JSON.stringify(data.templates[i]));
    template.currentExercise = 0;
    template.logs = template.exercises.map(e=>({
      name: e.name,
      sets: Array.from({length: e.sets}, () => ({weight:"",reps:""}))
    }));
    template.startedAt = new Date().toISOString();
    template.templateId = id;
    delete template.timerEnd; // fresh start
    data.activeWorkout = template;
    save();
    renderWorkout();
  };

  function renderWorkout() {
    const w = data.activeWorkout;
    if(!w) return renderHome();

    const exercise = w.logs[w.currentExercise];
    const app = document.getElementById("app");

    app.innerHTML = `
      <button onclick="endWorkout()">üèÅ End Workout</button>
      <h2>${exercise.name}</h2>
      ${exercise.sets.map((set,si)=>`
        <div class="exercise-card">
          <b>Set ${si+1}</b><br>
          <input placeholder="Weight (kg)" value="${set.weight || ''}" 
            onchange="updateSet(${si},'weight',this.value)">
          <input placeholder="Reps" value="${set.reps || ''}" 
            onchange="updateSet(${si},'reps',this.value)">
          <button class="small-btn" style="background:#2e7d32;" onclick="completeSet(${si})">‚úÖ Log & Rest</button>
        </div>
      `).join("")}
      <div class="timer" id="timer">${formatTime(w.rest)}</div>
      <button onclick="nextExercise()">‚è© Next Exercise</button>
    `;
    resumeTimerIfNeeded();
  }

  window.updateSet = (si,key,val) => {
    const w = data.activeWorkout;
    w.logs[w.currentExercise].sets[si][key] = val;
    save();
  };

  window.completeSet = (si) => {
    const w = data.activeWorkout;
    const set = w.logs[w.currentExercise].sets[si];
    if(parseInt(set.reps) > 15){
      alert("More than 15 reps. Consider increasing weight. Logged anyway.");
    }
    startTimer(w.rest);
  };

  window.nextExercise = () => {
    const w = data.activeWorkout;
    if(w.currentExercise < w.logs.length-1){
      w.currentExercise++;
      delete w.timerEnd; // clear rest timer
      clearTimer();
      save();
      renderWorkout();
    } else {
      const historyEntry = {
        date: new Date().toISOString(),
        templateName: w.name,
        logs: w.logs,
        id: w.templateId
      };
      data.history.push(historyEntry);
      data.activeWorkout = null;
      clearTimer();
      save();
      alert("Workout complete! Saved to history.");
      renderHome();
    }
  };

  window.endWorkout = () => {
    if (data.activeWorkout) {
      if (confirm('Save current progress to history?')) {
        const w = data.activeWorkout;
        data.history.push({
          date: new Date().toISOString(),
          templateName: w.name,
          logs: w.logs,
          id: w.templateId
        });
      }
    }
    data.activeWorkout = null;
    clearTimer();
    save();
    renderHome();
  };

  // Expose globals
  window.renderHome = renderHome;
  window.save = save;

  // Initial render & timer resume
  renderHome();
  resumeTimerIfNeeded();
})();
</script>
</body>
</html>
